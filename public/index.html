<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holzeinschlag √ñsterreich - Waldverlust & CO‚ÇÇ-Emissionen nach Gemeinde</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interaktive Karte des Holzeinschlags in √ñsterreich: Waldverlust, CO‚ÇÇ-Emissionen und ETS-Haftung f√ºr alle 2.118 Gemeinden von 2001-2023. Basierend auf Hansen Satellitendaten und offiziellen BML-Statistiken.">
    <meta name="keywords" content="Holzeinschlag, √ñsterreich, Waldverlust, CO2 Emissionen, ETS, Forstwirtschaft, Gemeinden, Klimawandel, Hansen Global Forest Change">
    <meta name="author" content="Holzeinschlag √ñsterreich">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://holzeinschlag-at.exe.xyz:8000/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://holzeinschlag-at.exe.xyz:8000/">
    <meta property="og:title" content="Holzeinschlag √ñsterreich - Waldverlust & CO‚ÇÇ-Emissionen nach Gemeinde">
    <meta property="og:description" content="Interaktive Karte: Waldverlust, CO‚ÇÇ-Emissionen und ETS-Haftung f√ºr alle 2.118 √∂sterreichischen Gemeinden von 2001-2023.">
    <meta property="og:image" content="https://holzeinschlag-at.exe.xyz:8000/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="de_AT">
    <meta property="og:site_name" content="Holzeinschlag √ñsterreich">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://holzeinschlag-at.exe.xyz:8000/">
    <meta name="twitter:title" content="Holzeinschlag √ñsterreich - Waldverlust & CO‚ÇÇ-Emissionen nach Gemeinde">
    <meta name="twitter:description" content="Interaktive Karte: Waldverlust, CO‚ÇÇ-Emissionen und ETS-Haftung f√ºr alle 2.118 √∂sterreichischen Gemeinden von 2001-2023.">
    <meta name="twitter:image" content="https://holzeinschlag-at.exe.xyz:8000/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå≤</text></svg>">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Holzeinschlag √ñsterreich",
        "description": "Interaktive Karte des Holzeinschlags in √ñsterreich mit Waldverlust, CO‚ÇÇ-Emissionen und ETS-Haftung f√ºr alle 2.118 Gemeinden.",
        "url": "https://holzeinschlag-at.exe.xyz:8000/",
        "applicationCategory": "EnvironmentalData",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
        },
        "author": {
            "@type": "Organization",
            "name": "Holzeinschlag √ñsterreich"
        },
        "datePublished": "2024-01-13",
        "inLanguage": "de-AT"
    }
    </script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2d5a27;
            --primary-dark: #1e3d1a;
            --accent: #e67e22;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 400px;
            background: var(--card-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        .sidebar-header h1 { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.25rem; }
        .sidebar-header .subtitle { font-size: 0.85rem; opacity: 0.9; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 1rem; }
        
        /* Year toggle buttons */
        .year-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 8px;
        }
        .year-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
            background: white;
            color: var(--text);
        }
        .year-btn:hover { background: #e8f5e9; }
        .year-btn.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        .year-btn.in-range {
            background: #a5d6a7;
            color: var(--primary-dark);
        }
        .year-btn.range-start,
        .year-btn.range-end {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        .year-btn.loading {
            opacity: 0.5;
            cursor: wait;
        }
        .year-range-hint {
            font-size: 0.65rem;
            color: var(--text-light);
            text-align: center;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.8;
        }
        .year-range-label {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.25rem;
        }
        
        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 0.875rem;
        }
        .stat-card.full-width { grid-column: 1 / -1; }
        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .stat-value.small { font-size: 1.1rem; }
        .stat-unit { font-size: 0.75rem; color: var(--text-light); font-weight: 400; }
        
        /* Section headers */
        .section-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 1rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-header::after { content: ''; flex: 1; height: 1px; background: #e0e0e0; }
        
        /* Municipality list */
        .muni-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .muni-item {
            display: flex;
            align-items: center;
            padding: 0.625rem 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .muni-item:hover { background: #e8f5e9; transform: translateX(4px); }
        .muni-item.active { background: #c8e6c9; border-left: 3px solid var(--primary); }
        .muni-rank {
            width: 22px; height: 22px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            margin-right: 0.6rem;
            flex-shrink: 0;
        }
        .muni-info { flex: 1; min-width: 0; }
        .muni-name { font-weight: 500; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .muni-state { font-size: 0.7rem; color: var(--text-light); }
        .muni-stats { text-align: right; font-size: 0.8rem; }
        .muni-harvest { font-weight: 600; color: var(--primary); }
        .muni-value { font-size: 0.7rem; color: var(--text-light); }
        
        /* Load more button */
        .load-more {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background: transparent;
            color: var(--text-light);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .load-more:hover { border-color: var(--primary); color: var(--primary); background: #f0f7f0; }
        
        /* Legend (positioned inside map) */
        .map-legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 160px;
        }
        .map-legend-title { font-size: 0.7rem; font-weight: 600; margin-bottom: 4px; color: #333; }
        .map-legend-scale { height: 8px; border-radius: 4px; background: linear-gradient(90deg, #f5f5f5, #c8e6c9, #81c784, #4caf50, #388e3c, #1b5e20); }
        .map-legend-labels { display: flex; justify-content: space-between; font-size: 0.6rem; color: #666; margin-top: 3px; }
        
        /* Shift hint toast */
        .shift-hint {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(25, 118, 210, 0.95);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeInUp 0.3s ease-out;
        }
        .shift-hint-icon { font-size: 1.1rem; }
        .shift-hint-close {
            background: none;
            border: none;
            color: white;
            opacity: 0.7;
            cursor: pointer;
            padding: 0 0 0 8px;
            font-size: 1rem;
        }
        .shift-hint-close:hover { opacity: 1; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Footer */
        .sidebar-footer {
            padding: 0.875rem;
            border-top: 1px solid #e0e0e0;
            font-size: 0.7rem;
            color: var(--text-light);
        }
        .sidebar-footer a { color: var(--primary); text-decoration: none; }
        
        /* Map */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        
        /* Popup */
        .leaflet-popup-content-wrapper { border-radius: 10px; }
        .popup-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; color: var(--primary); }
        .popup-year-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: #666;
        }
        .popup-nav-btn {
            background: var(--bg);
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 28px;
            height: 24px;
            cursor: pointer;
            font-size: 0.7rem;
            color: var(--primary);
            transition: all 0.15s;
        }
        .popup-nav-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .popup-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .popup-stat { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.85rem; }
        .popup-stat-label { color: var(--text-light); }
        .popup-stat-value { font-weight: 500; }
        .popup-highlight { background: #e8f5e9; margin: 0.25rem -0.5rem; padding: 0.25rem 0.5rem; }
        
        /* Loading spinner */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid var(--bg);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Search box */
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 90, 39, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }
        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: #e8f5e9; }
        .search-result-name { font-weight: 500; font-size: 0.9rem; }
        .search-result-state { font-size: 0.75rem; color: var(--text-light); }
        
        /* Multi-select UI */
        .multi-select-bar {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .multi-select-info {
            flex: 1;
        }
        .multi-select-count {
            font-weight: 600;
            color: #1565c0;
        }
        .multi-select-hint {
            font-size: 0.75rem;
            color: #546e7a;
            margin-top: 0.25rem;
        }
        .multi-select-actions {
            display: flex;
            gap: 0.5rem;
        }
        .multi-select-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        .multi-select-btn:hover { background: #1565c0; }
        .multi-select-btn.secondary {
            background: #f5f5f5;
            color: #424242;
        }
        .multi-select-btn.secondary:hover { background: #e0e0e0; }
        .selected-muni {
            outline: 3px solid #1976d2 !important;
            outline-offset: -3px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal h2 { color: var(--primary); margin-bottom: 1rem; font-size: 1.2rem; }
        .modal h3 { color: var(--text); margin: 1rem 0 0.5rem; font-size: 0.95rem; }
        .modal p, .modal li { font-size: 0.85rem; line-height: 1.5; color: var(--text); margin-bottom: 0.5rem; }
        .modal ul { padding-left: 1.2rem; }
        .modal a { color: var(--primary); }
        .modal-close {
            float: right;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }
        .modal-close:hover { color: var(--text); }
        
        /* Municipality detail modal */
        .muni-modal {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        .muni-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .muni-modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }
        .muni-modal-subtitle {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        .muni-modal-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }
        .muni-modal-nav-btn {
            background: var(--bg);
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 32px;
            height: 28px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--primary);
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .muni-modal-nav-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .muni-modal-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .muni-modal-chart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: visible;
        }
        .muni-modal-year {
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.35rem;
        }
        .muni-modal-chart {
            display: flex;
            align-items: flex-end;
            height: 40px;
            gap: 2px;
            padding: 0 12px 16px 12px;  /* Side padding for year labels, bottom for labels */
        }
        .muni-modal-chart-bar {
            flex: 1;
            min-width: 8px;
            background: #c8e6c9;
            border-radius: 2px 2px 0 0;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }
        .muni-modal-chart-bar:hover {
            background: #81c784;
        }
        .muni-modal-chart-bar.active {
            background: var(--primary);
        }
        .muni-modal-chart-bar.active:hover {
            background: var(--primary-dark);
        }
        .muni-modal-chart-bar.in-range {
            background: #a5d6a7;
        }
        .muni-modal-chart-bar.range-start,
        .muni-modal-chart-bar.range-end {
            background: var(--primary);
        }
        .muni-modal-chart-bar::after {
            content: attr(data-year);
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: transparent;
            white-space: nowrap;
            pointer-events: none;
        }
        .muni-modal-chart-bar:first-of-type::after {
            color: var(--text-light);
            left: 0;
            transform: none;
        }
        .muni-modal-chart-bar:last-of-type::after {
            color: var(--text-light);
            left: auto;
            right: 0;
            transform: none;
        }
        .muni-modal-chart-bar.active::after,
        .muni-modal-chart-bar:first-of-type.active::after,
        .muni-modal-chart-bar:last-of-type.active::after {
            color: var(--primary);
            font-weight: 600;
        }
        .muni-modal-chart-labels {
            display: none;  /* Labels now shown on bars */
        }
        .muni-modal-year-old {
            flex: 1;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }
        .muni-modal-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .muni-modal-stat {
            background: var(--bg);
            border-radius: 10px;
            padding: 1rem;
        }
        .muni-modal-stat.full { grid-column: 1 / -1; }
        .muni-modal-stat.highlight-red { background: #ffebee; }
        .muni-modal-stat.highlight-orange { background: #fff3e0; }
        .muni-modal-stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        .muni-modal-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }
        .muni-modal-stat-value.red { color: #c0392b; }
        .muni-modal-stat-value.orange { color: #e65100; }
        .muni-modal-stat-unit {
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-light);
        }
        .muni-modal-footer {
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
        }
        
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 40vh; }
            .map-container { min-height: 60vh; }
            .sidebar-header { padding: 1rem; }
            .sidebar-header h1 { font-size: 1.1rem; }
            .sidebar-content { padding: 0.75rem; }
            .year-toggles { gap: 3px; padding: 0.4rem; }
            .year-btn { padding: 5px 7px; font-size: 0.7rem; }
            .stats-grid { gap: 0.5rem; }
            .stat-card { padding: 0.6rem; }
            .stat-value { font-size: 1.1rem; }
            .stat-value.small { font-size: 0.95rem; }
            .section-header { font-size: 0.8rem; margin: 0.75rem 0 0.5rem; }
            .muni-item { padding: 0.5rem; }
            .muni-name { font-size: 0.8rem; }
            .muni-stats { font-size: 0.75rem; }
            .search-input { padding: 0.6rem 0.8rem 0.6rem 2.2rem; font-size: 0.85rem; }
            .search-icon { left: 0.7rem; font-size: 0.85rem; }
            /* Modal adjustments */
            .modal { padding: 1rem; margin: 0.5rem; max-height: 90vh; }
            .muni-modal-title { font-size: 1.2rem; }
            .muni-modal-stats { gap: 0.5rem; }
            .muni-modal-stat { padding: 0.75rem; }
            .muni-modal-stat-value { font-size: 1.1rem; }
            .muni-modal-nav-btn { width: 28px; height: 26px; font-size: 0.7rem; }
            .muni-modal-chart { height: 35px; gap: 1px; }
            .muni-modal-chart-bar { min-width: 6px; }
            .muni-modal-year { font-size: 0.9rem; }
        }
        
        @media (max-width: 480px) {
            .sidebar { max-height: 35vh; }
            .map-container { min-height: 65vh; }
            .stats-grid { grid-template-columns: 1fr; }
            .stat-card.full-width { grid-column: 1; }
            .year-btn { padding: 4px 6px; font-size: 0.65rem; }
            .muni-modal-stats { grid-template-columns: 1fr; }
            .muni-modal-stat.full { grid-column: 1; }
            .muni-modal-chart { height: 30px; }
            .muni-modal-chart-bar { min-width: 5px; }
        }
    </style>
</head>
<body>
    <div class="app-container" x-data="holzeinschlagApp()">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üå≤ Holzeinschlag √ñsterreich</h1>
                <div class="subtitle">Forest Loss & Carbon Emissions by Municipality</div>
            </div>
            
            <div class="sidebar-content">
                <!-- Search box -->
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" 
                           class="search-input" 
                           placeholder="Gemeinde suchen..."
                           x-model="searchQuery"
                           @input="onSearchInput()"
                           @focus="showSearchResults = searchQuery.length >= 2"
                           @blur="setTimeout(() => showSearchResults = false, 200)"
                           @keydown.escape="showSearchResults = false; searchQuery = ''">
                    <div class="search-results" x-show="showSearchResults && searchResults.length > 0" x-cloak>
                        <template x-for="result in searchResults" :key="result.iso">
                            <div class="search-result-item" @mousedown="selectSearchResult(result)">
                                <div class="search-result-name" x-text="result.name"></div>
                                <div class="search-result-state" x-text="result.state"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Year toggle buttons -->
                <div class="year-range-label" x-show="isRangeSelected" x-cloak>
                    <span x-show="processingRange">‚è≥ Berechne...</span>
                    <span x-show="!processingRange" x-text="rangeLabel"></span>
                </div>
                <div class="year-toggles">
                    <template x-for="year in availableYears" :key="year">
                        <button class="year-btn"
                                :class="getYearButtonClass(year)"
                                @click="handleYearClick($event, year)"
                                x-text="year"></button>
                    </template>
                </div>
                <div class="year-range-hint" x-show="!isRangeSelected">
                    <span x-show="preloadProgress < 100">Lade Daten... <span x-text="preloadProgress + '%'"></span></span>
                    <span x-show="preloadProgress >= 100">Shift+Klick f√ºr Zeitraum</span>
                </div>
                <div class="year-range-hint" x-show="isRangeSelected">
                    <a href="#" @click.prevent="clearRange()" style="color: var(--primary);">Zeitraum aufheben</a>
                </div>
                
                <!-- Multi-select info bar -->
                <div class="multi-select-bar" x-show="selectedMunis.size > 0" x-cloak>
                    <div class="multi-select-info">
                        <div class="multi-select-count">
                            <span x-text="selectedMunis.size"></span> Gemeinden ausgew√§hlt
                        </div>
                        <div class="multi-select-hint">Shift+Klick f√ºr weitere, Klick ohne Shift zum Zur√ºcksetzen</div>
                    </div>
                    <div class="multi-select-actions">
                        <button class="multi-select-btn" @click="showMultiSelectModal()">üìä Anzeigen</button>
                        <button class="multi-select-btn secondary" @click="clearMultiSelect()">‚úï Aufheben</button>
                    </div>
                </div>
                
                <!-- Austria totals -->
                <div class="stats-grid">
                    <div class="stat-card full-width">
                        <div class="stat-label">üõ∞Ô∏è Waldverlust (Hansen Satellitendaten)</div>
                        <div class="stat-value">
                            <span x-text="formatNumber(yearSummary?.total_loss_area_ha)"></span>
                            <span class="stat-unit">ha</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üå≤ Gesch. Einschlag</div>
                        <div class="stat-value small">
                            <span x-text="formatNumber(yearSummary?.total_harvest_efm)"></span>
                            <span class="stat-unit">Efm</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üí∞ Holzwert</div>
                        <div class="stat-value small">
                            ‚Ç¨<span x-text="formatMillion(yearSummary?.total_value_eur)"></span>
                            <span class="stat-unit">Mio.</span>
                        </div>
                    </div>
                    <div class="stat-card" style="background: #ffebee;">
                        <div class="stat-label">üè≠ CO‚ÇÇ-Emissionen</div>
                        <div class="stat-value small" style="color: #c0392b;">
                            <span x-text="formatNumber(yearSummary?.total_co2_tonnes)"></span>
                            <span class="stat-unit">t</span>
                        </div>
                    </div>
                    <div class="stat-card" style="background: #fff3e0;">
                        <div class="stat-label">üí∏ ETS-Haftung</div>
                        <div class="stat-value small" style="color: #e65100;">
                            ‚Ç¨<span x-text="formatMillion(yearSummary?.total_ets_liability_eur)"></span>
                            <span class="stat-unit">Mio.</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üìä ETS-Preis</div>
                        <div class="stat-value small">
                            ‚Ç¨<span x-text="yearSummary?.ets_price_eur_tco2"></span>
                            <span class="stat-unit">/tCO‚ÇÇ</span>
                        </div>
                    </div>
                </div>
                
                <!-- Top municipalities -->
                <div class="section-header">üèÜ Top Gemeinden in Karte (Efm)</div>
                <div class="muni-list">
                    <template x-for="(muni, index) in displayedMunicipalities" :key="muni.iso">
                        <div class="muni-item"
                             :class="{ active: selectedMuni === muni.iso }"
                             @click="selectMuni(muni.iso)"
                             @mouseenter="highlightMuni(muni.iso)"
                             @mouseleave="highlightMuni(null)">
                            <div class="muni-rank" x-text="index + 1"></div>
                            <div class="muni-info">
                                <div class="muni-name" x-text="muni.name"></div>
                                <div class="muni-state" x-text="muni.state"></div>
                            </div>
                            <div class="muni-stats">
                                <div class="muni-harvest" x-text="formatNumber(muni.harvest) + ' Efm'"></div>
                                <div class="muni-value" x-text="'‚Ç¨' + formatThousand(muni.value)"></div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Load more -->
                <button class="load-more" 
                        x-show="displayCount < sortedMunicipalities.length"
                        @click="loadMore()">
                    Mehr laden (<span x-text="displayCount"></span> / <span x-text="sortedMunicipalities.length"></span>)
                </button>
                

            </div>
            
            <div class="sidebar-footer">
                <a href="#" @click.prevent="showMethodsModal = true" style="margin-right: 1rem;">Methoden & Quellen</a>
                <a href="/holzeinschlag_austria.gpkg" download>üì• GeoPackage</a>
            </div>
        </aside>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <div class="loading-overlay" x-show="loading" x-cloak>
                <div class="spinner"></div>
            </div>
            <!-- Shift hint -->
            <div class="shift-hint" x-show="showShiftHint" x-cloak x-transition>
                <span class="shift-hint-icon">‚å®Ô∏è</span>
                <span>Tipp: Halte <strong>Shift</strong> gedr√ºckt und klicke mehrere Gemeinden um sie zu vergleichen</span>
                <button class="shift-hint-close" @click="dismissShiftHint()">‚úï</button>
            </div>
            <!-- Map Legend -->
            <div class="map-legend">
                <div class="map-legend-title">Einschlag pro Gemeinde</div>
                <div class="map-legend-scale"></div>
                <div class="map-legend-labels">
                    <span>0</span>
                    <span>50k</span>
                    <span>200k</span>
                    <span>400k+ Efm</span>
                </div>
            </div>
        </div>
        
        <!-- Municipality Detail Modal -->
        <div class="modal-overlay" x-show="showMuniModal" x-cloak @click.self="closeMuniModal()">
            <div class="modal muni-modal" @click.stop>
                <div class="muni-modal-header">
                    <div>
                        <div class="muni-modal-title" x-text="modalMuniData?.name"></div>
                        <div class="muni-modal-subtitle" x-text="modalMuniData?.state"></div>
                    </div>
                    <button class="modal-close" @click="closeMuniModal()">&times;</button>
                </div>
                
                <div class="muni-modal-nav">
                    <button class="muni-modal-nav-btn" 
                            :disabled="!canGoPrevYear || isRangeSelected" 
                            @click="prevYearModal()">‚óÄ</button>
                    <div class="muni-modal-chart-container">
                        <div class="muni-modal-year" x-text="isRangeSelected ? rangeLabel : selectedYear"></div>
                        <div class="muni-modal-chart">
                            <template x-for="year in availableYears" :key="year">
                                <div class="muni-modal-chart-bar" 
                                     :class="getModalChartBarClass(year)"
                                     :style="{ height: getYearBarHeight(year) + '%' }"
                                     :data-year="year.slice(-2)"
                                     :title="year + ': ' + formatNumber(getYearLossArea(year)) + ' ha'"
                                     @click="handleModalChartClick($event, year)"></div>
                            </template>
                        </div>
                    </div>
                    <button class="muni-modal-nav-btn" 
                            :disabled="!canGoNextYear || isRangeSelected" 
                            @click="nextYearModal()">‚ñ∂</button>
                </div>
                
                <div class="muni-modal-stats">
                    <div class="muni-modal-stat full">
                        <div class="muni-modal-stat-label">üõ∞Ô∏è Waldverlust (Satellitendaten)</div>
                        <div class="muni-modal-stat-value">
                            <span x-text="formatNumber(modalMuniData?.lossArea)"></span>
                            <span class="muni-modal-stat-unit">ha</span>
                        </div>
                    </div>
                    <div class="muni-modal-stat">
                        <div class="muni-modal-stat-label">ü™µ Gesch. Einschlag</div>
                        <div class="muni-modal-stat-value">
                            <span x-text="formatNumber(modalMuniData?.harvest)"></span>
                            <span class="muni-modal-stat-unit">Efm</span>
                        </div>
                    </div>
                    <div class="muni-modal-stat">
                        <div class="muni-modal-stat-label">üí∞ Holzwert</div>
                        <div class="muni-modal-stat-value">
                            ‚Ç¨<span x-text="formatNumber(modalMuniData?.value)"></span>
                        </div>
                    </div>
                    <div class="muni-modal-stat highlight-red">
                        <div class="muni-modal-stat-label">üè≠ CO‚ÇÇ-Emissionen</div>
                        <div class="muni-modal-stat-value red">
                            <span x-text="formatNumber(modalMuniData?.co2)"></span>
                            <span class="muni-modal-stat-unit">t</span>
                        </div>
                    </div>
                    <div class="muni-modal-stat highlight-orange">
                        <div class="muni-modal-stat-label">üí∏ ETS-Haftung</div>
                        <div class="muni-modal-stat-value orange">
                            ‚Ç¨<span x-text="formatNumber(modalMuniData?.ets)"></span>
                        </div>
                    </div>
                    <div class="muni-modal-stat">
                        <div class="muni-modal-stat-label">üë• ETS pro Kopf</div>
                        <div class="muni-modal-stat-value">
                            ‚Ç¨<span x-text="formatNumber(modalMuniData?.etsPc)"></span>
                        </div>
                    </div>
                </div>
                
                <div class="muni-modal-footer">
                    <span>Bev√∂lkerung: <span x-text="formatNumber(modalMuniData?.population)"></span></span>
                    <span>ETS-Preis: ‚Ç¨<span x-text="yearSummary?.ets_price_eur_tco2"></span>/tCO‚ÇÇ</span>
                </div>
            </div>
        </div>
        
        <!-- Methods Modal -->
        <div class="modal-overlay" x-show="showMethodsModal" x-cloak @click.self="showMethodsModal = false">
            <div class="modal">
                <button class="modal-close" @click="showMethodsModal = false">&times;</button>
                <h2>üìä Methoden & Datenquellen</h2>
                
                <h3>üõ∞Ô∏è Waldverlust (Forest Loss)</h3>
                <p>Satellitendaten aus dem <a href="https://glad.umd.edu/dataset/gfc-2023-v1.11" target="_blank">Hansen Global Forest Change</a> Datensatz (v1.11, 2023). 30m Aufl√∂sung, Wert 1-23 entspricht Verlustjahr 2001-2023.</p>
                
                <h3>üå≤ Gesch√§tzter Einschlag</h3>
                <p>Berechnet aus Waldverlustfl√§che √ó bundeslandspezifischem Efm/ha-Faktor. Der Faktor basiert auf dem Verh√§ltnis von offiziellen Einschlagszahlen (<a href="https://www.bmluk.gv.at" target="_blank">BML</a>) zur Hansen-Verlustfl√§che pro Bundesland.</p>
                
                <h3>üí∞ Holzwert</h3>
                <p>Gesch√§tzter Einschlag √ó historischer Holzpreis (gewichteter Durchschnitt aus S√§gerundholz und Industrieholz).</p>
                
                <h3>üè≠ CO‚ÇÇ-Emissionen</h3>
                <p>Berechnung basiert auf Schadholzanteil:</p>
                <ul>
                    <li>Schadholzfraktion: 40-55% je Bundesland</li>
                    <li>Emissionsfaktor: 0.9 tCO‚ÇÇ/m¬≥ f√ºr Holz, das verbrannt oder zu Zellstoff verarbeitet wird</li>
                    <li>Nachhaltig bewirtschaftetes S√§geholz wird nicht eingerechnet (Kohlenstoffbindung in Produkten)</li>
                </ul>
                
                <h3>üí∏ ETS-Haftung</h3>
                <p>CO‚ÇÇ-Emissionen √ó historischer EU-ETS-Preis. Preise von 2005-2023 basieren auf realen Marktdaten. <em>Hinweis: Forstwirtschaft ist derzeit nicht im EU-ETS enthalten - dies ist eine hypothetische Berechnung.</em></p>
                
                <h3>üì• Datendownload</h3>
                <p>GeoPackage enth√§lt alle 2.118 Gemeinden mit Daten f√ºr 2001-2023. Felder pro Jahr:</p>
                <ul>
                    <li><code>loss_pixels_YYYY</code> - Anzahl 30m-Pixel</li>
                    <li><code>loss_area_ha_YYYY</code> - Verlustfl√§che in Hektar</li>
                    <li><code>harvest_efm_YYYY</code> - Gesch√§tzter Einschlag</li>
                    <li><code>value_eur_YYYY</code> - Holzwert in EUR</li>
                    <li><code>co2_tonnes_YYYY</code> - CO‚ÇÇ-Emissionen</li>
                    <li><code>ets_eur_YYYY</code> - ETS-Haftung</li>
                    <li><code>ets_per_capita_YYYY</code> - ETS pro Einwohner</li>
                </ul>
                
                <h3>‚ö†Ô∏è Einschr√§nkungen</h3>
                <ul>
                    <li>Hansen-Daten erfassen Kronenverlust, nicht nur Holzeinschlag</li>
                    <li>Einschlagsch√§tzung ist ein Proxy, keine direkte Messung</li>
                    <li>Bev√∂lkerungsdaten nur f√ºr aktuelle Jahre verf√ºgbar</li>
                </ul>
            </div>
        </div>
        
        <!-- Cluster Modal -->
        <!-- Multi-Select Modal -->
        <div class="modal-overlay" x-show="showMultiModal" x-cloak @click.self="closeMultiModal()">
            <div class="modal muni-modal" @click.stop>
                <div class="muni-modal-header">
                    <div>
                        <div class="muni-modal-title">üìç <span x-text="selectedMunis.size"></span> Gemeinden</div>
                        <div class="muni-modal-subtitle">Kombinierte Statistik</div>
                    </div>
                    <button class="modal-close" @click="closeMultiModal()">&times;</button>
                </div>
                
                <div class="muni-modal-nav">
                    <button class="muni-modal-nav-btn" 
                            :disabled="!canGoPrevYear || isRangeSelected" 
                            @click="prevYearModal()">‚óÄ</button>
                    <div class="muni-modal-chart-container">
                        <div class="muni-modal-year" x-text="isRangeSelected ? rangeLabel : selectedYear"></div>
                        <div class="muni-modal-chart">
                            <template x-for="year in availableYears" :key="year">
                                <div class="muni-modal-chart-bar" 
                                     :class="getModalChartBarClass(year)"
                                     :style="{ height: getMultiYearBarHeight(year) + '%' }"
                                     :data-year="year.slice(-2)"
                                     :title="year + ': ' + formatNumber(getMultiYearLossArea(year)) + ' ha'"
                                     @click="handleModalChartClick($event, year)"></div>
                            </template>
                        </div>
                    </div>
                    <button class="muni-modal-nav-btn" 
                            :disabled="!canGoNextYear || isRangeSelected" 
                            @click="nextYearModal()">‚ñ∂</button>
                </div>
                
                <div class="muni-modal-stats">
                    <div class="muni-modal-stat full">
                        <div class="muni-modal-stat-label">üõ∞Ô∏è Waldverlust (Satellitendaten)</div>
                        <div class="muni-modal-stat-value">
                            <span x-text="formatNumber(multiSelectData?.lossArea)"></span>
                            <span class="muni-modal-stat-unit">ha</span>
                        </div>
                    </div>
                    <div class="muni-modal-stat">
                        <div class="muni-modal-stat-label">ü™µ Gesch. Einschlag</div>
                        <div class="muni-modal-stat-value">
                            <span x-text="formatNumber(multiSelectData?.harvest)"></span>
                            <span class="muni-modal-stat-unit">Efm</span>
                        </div>
                    </div>
                    <div class="muni-modal-stat">
                        <div class="muni-modal-stat-label">üí∞ Holzwert</div>
                        <div class="muni-modal-stat-value">
                            ‚Ç¨<span x-text="formatNumber(multiSelectData?.value)"></span>
                        </div>
                    </div>
                    <div class="muni-modal-stat highlight-red">
                        <div class="muni-modal-stat-label">üè≠ CO‚ÇÇ-Emissionen</div>
                        <div class="muni-modal-stat-value red">
                            <span x-text="formatNumber(multiSelectData?.co2)"></span>
                            <span class="muni-modal-stat-unit">t</span>
                        </div>
                    </div>
                    <div class="muni-modal-stat highlight-orange">
                        <div class="muni-modal-stat-label">üí∏ ETS-Haftung</div>
                        <div class="muni-modal-stat-value orange">
                            ‚Ç¨<span x-text="formatNumber(multiSelectData?.ets)"></span>
                        </div>
                    </div>
                    <div class="muni-modal-stat">
                        <div class="muni-modal-stat-label">üë• ETS pro Kopf</div>
                        <div class="muni-modal-stat-value">
                            ‚Ç¨<span x-text="formatNumber(multiSelectData?.etsPc)"></span>
                        </div>
                    </div>
                </div>
                
                <div class="muni-modal-footer">
                    <span>Bev√∂lkerung: <span x-text="formatNumber(multiSelectData?.population)"></span></span>
                    <span>ETS-Preis: ‚Ç¨<span x-text="yearSummary?.ets_price_eur_tco2"></span>/tCO‚ÇÇ</span>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
                    <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.5rem;">Ausgew√§hlte Gemeinden:</div>
                    <div style="max-height: 100px; overflow-y: auto; font-size: 0.75rem;">
                        <template x-for="iso in Array.from(selectedMunis)" :key="iso">
                            <span style="display: inline-block; background: #e3f2fd; padding: 0.2rem 0.5rem; margin: 0.1rem; border-radius: 4px; color: #1565c0;" x-text="lookup?.names?.[iso] || iso"></span>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function holzeinschlagApp() {
            return {
                // Data stores
                meta: null,
                lookup: null,
                yearData: {},      // Cache: { year: data }
                gemeindenGeoJson: null,
                
                // UI state
                selectedYear: '2024',
                rangeStartYear: null,    // For range selection
                rangeEndYear: null,      // For range selection
                selectedMuni: null,
                highlightedMuni: null,
                displayCount: 20,
                loading: true,
                loadingYear: null,
                preloadProgress: 0,      // 0-100 progress of background preload
                processingRange: false,  // True while processing range selection
                cachedAggregatedData: null, // Cached aggregated data for range
                showMethodsModal: false,
                showMuniModal: false,
                modalMuniIso: null,
                visibleIsos: new Set(),  // ISOs visible in current map extent
                
                // Multi-select
                selectedMunis: new Set(),  // Set of ISO codes for shift-click selection
                showMultiModal: false,
                showShiftHint: false,      // Show hint about shift-click
                
                // Search
                searchQuery: '',
                searchResults: [],
                showSearchResults: false,
                
                // Map
                map: null,
                gemeindenLayer: null,
                activePopup: null,
                
                get availableYears() {
                    return this.meta?.years || [];
                },
                
                get isRangeSelected() {
                    return this.rangeStartYear !== null && this.rangeEndYear !== null;
                },
                
                get rangeYears() {
                    if (!this.isRangeSelected) return [this.selectedYear];
                    const start = Math.min(parseInt(this.rangeStartYear), parseInt(this.rangeEndYear));
                    const end = Math.max(parseInt(this.rangeStartYear), parseInt(this.rangeEndYear));
                    return this.availableYears.filter(y => {
                        const yr = parseInt(y);
                        return yr >= start && yr <= end;
                    });
                },
                
                get rangeLabel() {
                    if (!this.isRangeSelected) return this.selectedYear;
                    const years = this.rangeYears;
                    return `${years[0]} - ${years[years.length - 1]} (${years.length} Jahre)`;
                },
                
                get yearSummary() {
                    if (!this.isRangeSelected) {
                        return this.meta?.summary?.[this.selectedYear];
                    }
                    // Aggregate summary across range
                    return this.getAggregatedSummary();
                },
                
                get currentYearData() {
                    if (!this.isRangeSelected) {
                        return this.yearData[this.selectedYear] || {};
                    }
                    // Use cached aggregated data
                    return this.cachedAggregatedData || {};
                },
                
                getAggregatedSummary() {
                    const years = this.rangeYears;
                    const summary = {
                        total_loss_pixels: 0,
                        total_loss_area_ha: 0,
                        total_harvest_efm: 0,
                        total_value_eur: 0,
                        total_co2_tonnes: 0,
                        total_ets_liability_eur: 0,
                        ets_price_eur_tco2: 0,
                        timber_price_eur_efm: 0,
                        gemeinde_count: 0
                    };
                    
                    let etsSum = 0, timberSum = 0;
                    for (const year of years) {
                        const s = this.meta?.summary?.[year];
                        if (s) {
                            summary.total_loss_pixels += s.total_loss_pixels || 0;
                            summary.total_loss_area_ha += s.total_loss_area_ha || 0;
                            summary.total_harvest_efm += s.total_harvest_efm || 0;
                            summary.total_value_eur += s.total_value_eur || 0;
                            summary.total_co2_tonnes += s.total_co2_tonnes || 0;
                            summary.total_ets_liability_eur += s.total_ets_liability_eur || 0;
                            etsSum += s.ets_price_eur_tco2 || 0;
                            timberSum += s.timber_price_eur_efm || 0;
                        }
                    }
                    // Average prices
                    summary.ets_price_eur_tco2 = Math.round(etsSum / years.length);
                    summary.timber_price_eur_efm = Math.round(timberSum / years.length);
                    return summary;
                },
                
                computeAggregatedYearData() {
                    const years = this.rangeYears;
                    const aggregated = {};
                    
                    // Collect all ISOs across all years
                    const allIsos = new Set();
                    for (const year of years) {
                        const data = this.yearData[year] || {};
                        Object.keys(data).forEach(iso => allIsos.add(iso));
                    }
                    
                    // Aggregate each ISO
                    for (const iso of allIsos) {
                        let lossPixels = 0, lossArea = 0, harvest = 0, value = 0, co2 = 0, ets = 0;
                        for (const year of years) {
                            const d = this.yearData[year]?.[iso];
                            if (d) {
                                lossPixels += d[0] || 0;
                                lossArea += d[1] || 0;
                                harvest += d[2] || 0;
                                value += d[3] || 0;
                                co2 += d[4] || 0;
                                ets += d[5] || 0;
                            }
                        }
                        // d[6] is ets per capita - recalculate from total
                        const pop = this.lookup?.population?.[iso] || 0;
                        const etsPc = pop > 0 ? ets / pop : 0;
                        aggregated[iso] = [lossPixels, lossArea, harvest, value, co2, ets, etsPc];
                    }
                    return aggregated;
                },
                
                get modalMuniData() {
                    if (!this.modalMuniIso) return null;
                    const d = this.currentYearData[this.modalMuniIso];
                    if (!d) return {
                        name: this.lookup?.names?.[this.modalMuniIso] || this.modalMuniIso,
                        state: this.lookup?.states?.[this.modalMuniIso] || '',
                        population: this.lookup?.population?.[this.modalMuniIso] || 0,
                        lossArea: 0, harvest: 0, value: 0, co2: 0, ets: 0, etsPc: 0
                    };
                    return {
                        name: this.lookup?.names?.[this.modalMuniIso] || this.modalMuniIso,
                        state: this.lookup?.states?.[this.modalMuniIso] || '',
                        population: this.lookup?.population?.[this.modalMuniIso] || 0,
                        lossArea: Math.round(d[1] || 0),
                        harvest: Math.round(d[2] || 0),
                        value: Math.round(d[3] || 0),
                        co2: Math.round(d[4] || 0),
                        ets: Math.round(d[5] || 0),
                        etsPc: Math.round(d[6] || 0)
                    };
                },
                
                get canGoPrevYear() {
                    const idx = this.availableYears.indexOf(this.selectedYear);
                    return idx > 0;
                },
                
                get canGoNextYear() {
                    const idx = this.availableYears.indexOf(this.selectedYear);
                    return idx < this.availableYears.length - 1;
                },
                
                get sortedMunicipalities() {
                    const data = this.currentYearData;
                    const lookup = this.lookup || {};
                    
                    return Object.entries(data)
                        .filter(([iso]) => this.visibleIsos.size === 0 || this.visibleIsos.has(iso))
                        .map(([iso, d]) => ({
                            iso,
                            name: lookup.names?.[iso] || iso,
                            state: lookup.states?.[iso] || '',
                            lossPixels: d[0] || 0,
                            lossArea: d[1] || 0,
                            harvest: d[2] || 0,
                            value: d[3] || 0,
                            co2: d[4] || 0,
                            ets: d[5] || 0,
                            etsPc: d[6] || 0,
                            population: lookup.population?.[iso] || 0
                        }))
                        .sort((a, b) => b.harvest - a.harvest);
                },
                
                get displayedMunicipalities() {
                    return this.sortedMunicipalities.slice(0, this.displayCount);
                },
                
                updateVisibleMunicipalities() {
                    if (!this.map || !this.gemeindenLayer) return;
                    
                    const bounds = this.map.getBounds();
                    const visible = new Set();
                    
                    this.gemeindenLayer.eachLayer((layer) => {
                        const iso = layer.feature?.properties?.iso;
                        if (iso && bounds.intersects(layer.getBounds())) {
                            visible.add(iso);
                        }
                    });
                    
                    this.visibleIsos = visible;
                    this.displayCount = 20; // Reset when view changes
                },
                
                // Search functionality
                onSearchInput() {
                    const query = this.searchQuery.trim().toLowerCase();
                    if (query.length < 2) {
                        this.searchResults = [];
                        this.showSearchResults = false;
                        return;
                    }
                    
                    const names = this.lookup?.names || {};
                    const states = this.lookup?.states || {};
                    
                    this.searchResults = Object.entries(names)
                        .filter(([iso, name]) => name.toLowerCase().includes(query))
                        .slice(0, 10)
                        .map(([iso, name]) => ({
                            iso,
                            name,
                            state: states[iso] || ''
                        }));
                    
                    this.showSearchResults = this.searchResults.length > 0;
                },
                
                selectSearchResult(result) {
                    this.searchQuery = '';
                    this.showSearchResults = false;
                    this.selectedMuni = result.iso;
                    this.openMuniModal(result.iso);
                    
                    // Zoom to municipality
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.eachLayer((layer) => {
                            if (layer.feature?.properties?.iso === result.iso) {
                                const bounds = layer.getBounds();
                                this.map.flyToBounds(bounds, { 
                                    maxZoom: 11, 
                                    padding: [50, 50],
                                    duration: 1.0
                                });
                            }
                        });
                    }
                },
                
                // Modal functionality
                async openMuniModal(iso) {
                    this.modalMuniIso = iso;
                    this.showMuniModal = true;
                    this.closeAllPopups();
                    
                    // Preload all years data for the chart
                    await this.preloadAllYears();
                },
                
                async preloadAllYears() {
                    // Load all years in parallel for the chart
                    const promises = this.availableYears.map(year => this.loadYearData(year));
                    await Promise.all(promises);
                },
                
                closeMuniModal() {
                    this.showMuniModal = false;
                    this.modalMuniIso = null;
                },
                
                async prevYearModal() {
                    const idx = this.availableYears.indexOf(this.selectedYear);
                    if (idx > 0) {
                        await this.selectYear(this.availableYears[idx - 1]);
                    }
                },
                
                async nextYearModal() {
                    const idx = this.availableYears.indexOf(this.selectedYear);
                    if (idx < this.availableYears.length - 1) {
                        await this.selectYear(this.availableYears[idx + 1]);
                    }
                },
                
                closeAllPopups() {
                    if (this.map) {
                        this.map.closePopup();
                    }
                    this.activePopup = null;
                },
                
                async init() {
                    // Expose app instance globally for popup button callbacks
                    window.holzApp = this;
                    
                    this.loading = true;
                    
                    // Load metadata and lookup (small files, load first)
                    const [metaResp, lookupResp, geoResp] = await Promise.all([
                        fetch('/data/emissions_meta.json'),
                        fetch('/data/gemeinde_lookup.json'),
                        fetch('/data/austria_gemeinden.geojson')
                    ]);
                    
                    this.meta = await metaResp.json();
                    this.lookup = await lookupResp.json();
                    this.gemeindenGeoJson = await geoResp.json();
                    
                    // Load default year data
                    await this.loadYearData(this.selectedYear);
                    
                    // Initialize map
                    this.initMap();
                    this.loading = false;
                    
                    // Preload all years in background for faster range selection
                    this.preloadAllYears();
                },
                
                async preloadAllYears() {
                    // Load remaining years in background (low priority)
                    const yearsToLoad = this.availableYears.filter(y => !this.yearData[y]);
                    const total = yearsToLoad.length;
                    if (total === 0) {
                        this.preloadProgress = 100;
                        return;
                    }
                    
                    let loaded = 0;
                    // Load in batches of 4 to avoid overwhelming the connection
                    for (let i = 0; i < yearsToLoad.length; i += 4) {
                        const batch = yearsToLoad.slice(i, i + 4);
                        await Promise.all(batch.map(y => this.loadYearData(y)));
                        loaded += batch.length;
                        this.preloadProgress = Math.round((loaded / total) * 100);
                    }
                },
                
                async loadYearData(year) {
                    if (this.yearData[year]) return; // Already cached
                    
                    this.loadingYear = year;
                    const resp = await fetch(`/data/year_${year}.json`);
                    this.yearData[year] = await resp.json();
                    this.loadingYear = null;
                },
                
                async selectYear(year) {
                    if (year === this.selectedYear && !this.isRangeSelected) return;
                    
                    const currentMuni = this.selectedMuni;
                    const hadPopupOpen = this.activePopup && this.activePopup.isOpen();
                    
                    await this.loadYearData(year);
                    this.selectedYear = year;
                    this.displayCount = 20;
                    
                    // Update map colors
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                    
                    // Update popup content if one was open
                    if (currentMuni && hadPopupOpen && this.activePopup) {
                        const content = this.buildPopupContent(currentMuni);
                        this.activePopup.setContent(content);
                    }
                },
                
                async handleYearClick(event, year) {
                    if (event.shiftKey && this.selectedYear) {
                        // Shift+click: set range
                        this.rangeStartYear = this.selectedYear;
                        this.rangeEndYear = year;
                        this.processingRange = true;
                        
                        // Load all years in range
                        await this.loadRangeYears();
                        
                        // Pre-compute aggregated data ONCE (this was the slow part)
                        this.cachedAggregatedData = this.computeAggregatedYearData();
                        
                        // Defer map update to let UI show loading state
                        await new Promise(r => requestAnimationFrame(r));
                        
                        // Update display - now fast because data is cached
                        this.displayCount = 20;
                        if (this.gemeindenLayer) {
                            this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                        }
                        this.processingRange = false;
                    } else {
                        // Normal click: single year, clear range
                        this.rangeStartYear = null;
                        this.rangeEndYear = null;
                        this.cachedAggregatedData = null;
                        await this.selectYear(year);
                    }
                },
                
                async loadRangeYears() {
                    const years = this.rangeYears;
                    await Promise.all(years.map(y => this.loadYearData(y)));
                },
                
                clearRange() {
                    this.rangeStartYear = null;
                    this.rangeEndYear = null;
                    this.cachedAggregatedData = null;
                    this.displayCount = 20;
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                },
                
                // Multi-select methods
                toggleMultiSelect(iso) {
                    if (this.selectedMunis.has(iso)) {
                        this.selectedMunis.delete(iso);
                    } else {
                        this.selectedMunis.add(iso);
                    }
                    // Force reactivity
                    this.selectedMunis = new Set(this.selectedMunis);
                    this.updateMapStyles();
                },
                
                clearMultiSelect() {
                    this.selectedMunis = new Set();
                    this.updateMapStyles();
                },
                
                showShiftHintOnce() {
                    // Show hint only if not seen before
                    if (localStorage.getItem('shiftHintSeen')) return;
                    this.showShiftHint = true;
                    // Auto-hide after 6 seconds
                    setTimeout(() => this.dismissShiftHint(), 6000);
                },
                
                dismissShiftHint() {
                    this.showShiftHint = false;
                    localStorage.setItem('shiftHintSeen', 'true');
                },
                
                async showMultiSelectModal() {
                    // Ensure all year data is loaded for the chart
                    await this.preloadAllYears();
                    this.showMultiModal = true;
                },
                
                closeMultiModal() {
                    this.showMultiModal = false;
                },
                
                updateMapStyles() {
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                },
                
                get multiSelectData() {
                    if (this.selectedMunis.size === 0) return null;
                    
                    let totalLoss = 0, totalHarvest = 0, totalValue = 0, totalCo2 = 0, totalEts = 0, totalPop = 0;
                    
                    for (const iso of this.selectedMunis) {
                        const d = this.currentYearData[iso];
                        if (d) {
                            totalLoss += d[1] || 0;
                            totalHarvest += d[2] || 0;
                            totalValue += d[3] || 0;
                            totalCo2 += d[4] || 0;
                            totalEts += d[5] || 0;
                        }
                        totalPop += this.lookup?.population?.[iso] || 0;
                    }
                    
                    return {
                        count: this.selectedMunis.size,
                        population: totalPop,
                        lossArea: Math.round(totalLoss),
                        harvest: Math.round(totalHarvest),
                        value: Math.round(totalValue),
                        co2: Math.round(totalCo2),
                        ets: Math.round(totalEts),
                        etsPc: totalPop > 0 ? Math.round(totalEts / totalPop) : 0
                    };
                },
                
                getMultiYearLossArea(year) {
                    let total = 0;
                    // Use yearData which gets preloaded
                    const yearDataForYear = this.yearData[year];
                    if (!yearDataForYear) return 0;
                    
                    for (const iso of this.selectedMunis) {
                        const d = yearDataForYear[iso];
                        if (d) total += d[1] || 0;
                    }
                    return Math.round(total);
                },
                
                getMultiYearBarHeight(year) {
                    // Find max loss area across all years for selected municipalities
                    let maxLoss = 0;
                    for (const y of this.availableYears) {
                        const l = this.getMultiYearLossArea(y);
                        if (l > maxLoss) maxLoss = l;
                    }
                    
                    if (maxLoss === 0) return 5;
                    
                    const loss = this.getMultiYearLossArea(year);
                    return Math.max(5, (loss / maxLoss) * 100);
                },
                
                getYearButtonClass(year) {
                    const classes = {};
                    
                    if (this.loadingYear === year) {
                        classes.loading = true;
                    }
                    
                    if (this.isRangeSelected) {
                        const start = Math.min(parseInt(this.rangeStartYear), parseInt(this.rangeEndYear));
                        const end = Math.max(parseInt(this.rangeStartYear), parseInt(this.rangeEndYear));
                        const yr = parseInt(year);
                        
                        if (year === this.rangeStartYear || year === this.rangeEndYear) {
                            if (this.rangeStartYear === this.rangeEndYear) {
                                classes.active = true;
                            } else if (yr === start) {
                                classes['range-start'] = true;
                            } else {
                                classes['range-end'] = true;
                            }
                        } else if (yr > start && yr < end) {
                            classes['in-range'] = true;
                        }
                    } else {
                        if (year === this.selectedYear) {
                            classes.active = true;
                        }
                    }
                    
                    return classes;
                },
                
                prevYear(event) {
                    if (event) {
                        event.stopPropagation();
                        event.preventDefault();
                    }
                    const idx = this.availableYears.indexOf(this.selectedYear);
                    if (idx > 0) {
                        this.selectYear(this.availableYears[idx - 1]);
                    }
                },
                
                nextYear(event) {
                    if (event) {
                        event.stopPropagation();
                        event.preventDefault();
                    }
                    const idx = this.availableYears.indexOf(this.selectedYear);
                    if (idx < this.availableYears.length - 1) {
                        this.selectYear(this.availableYears[idx + 1]);
                    }
                },
                
                updatePopupContent(iso) {
                    if (!this.activePopup) return;
                    
                    const content = this.buildPopupContent(iso);
                    this.activePopup.setContent(content);
                },
                
                initMap() {
                    this.map = L.map('map', {
                        center: [47.5, 13.5],
                        zoom: 7,
                        zoomControl: false
                    });
                    
                    L.control.zoom({ position: 'bottomright' }).addTo(this.map);
                    
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© OSM ¬© CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(this.map);
                    
                    this.createGemeindenLayer();
                    
                    // Update visible municipalities on map move/zoom
                    this.map.on('moveend', () => this.updateVisibleMunicipalities());
                    this.map.on('zoomend', () => this.updateVisibleMunicipalities());
                    
                    // Initial update
                    this.$nextTick(() => this.updateVisibleMunicipalities());
                },
                
                createGemeindenLayer() {
                    this.gemeindenLayer = L.geoJSON(this.gemeindenGeoJson, {
                        style: (feature) => this.getStyle(feature),
                        onEachFeature: (feature, layer) => {
                            layer.on({
                                click: (e) => this.onMuniClick(e, feature, layer),
                                mouseover: (e) => {
                                    layer.setStyle({ weight: 2, color: '#1e3d1a' });
                                    layer.bringToFront();
                                },
                                mouseout: (e) => {
                                    this.gemeindenLayer.resetStyle(layer);
                                }
                            });
                        }
                    }).addTo(this.map);
                },
                
                getStyle(feature) {
                    const iso = feature.properties.iso;
                    const d = this.currentYearData[iso];
                    const harvest = d ? d[2] : 0;  // d[2] = harvest Efm
                    
                    const isHighlighted = this.highlightedMuni === iso || this.selectedMuni === iso;
                    const isMultiSelected = this.selectedMunis.has(iso);
                    
                    return {
                        fillColor: this.getColor(harvest),
                        weight: isHighlighted ? 2 : (isMultiSelected ? 3 : 0.5),
                        opacity: 1,
                        color: isMultiSelected ? '#1976d2' : (isHighlighted ? '#1e3d1a' : '#ffffff'),
                        fillOpacity: 0.75
                    };
                },
                
                getColor(harvest) {
                    if (!harvest || harvest === 0) return '#f5f5f5';
                    if (harvest < 5000) return '#e8f5e9';
                    if (harvest < 20000) return '#c8e6c9';
                    if (harvest < 50000) return '#a5d6a7';
                    if (harvest < 100000) return '#81c784';
                    if (harvest < 200000) return '#66bb6a';
                    if (harvest < 300000) return '#4caf50';
                    if (harvest < 400000) return '#43a047';
                    if (harvest < 500000) return '#388e3c';
                    return '#1b5e20';
                },
                
                onMuniClick(e, feature, layer) {
                    const iso = feature.properties.iso;
                    
                    // Shift+click for multi-select
                    if (e.originalEvent?.shiftKey) {
                        this.toggleMultiSelect(iso);
                        return;
                    }
                    
                    // Normal click - clear multi-select if any, then show single muni
                    if (this.selectedMunis.size > 0) {
                        this.clearMultiSelect();
                    }
                    
                    this.selectedMuni = iso;
                    this.openMuniModal(iso);
                    
                    // Show shift hint after first click
                    this.showShiftHintOnce();
                },
                
                buildPopupContent(iso) {
                    const d = this.currentYearData[iso];
                    const name = this.lookup?.names?.[iso] || iso;
                    const state = this.lookup?.states?.[iso] || '';
                    const pop = this.lookup?.population?.[iso] || 0;
                    
                    const yearIdx = this.availableYears.indexOf(this.selectedYear);
                    const hasPrev = yearIdx > 0;
                    const hasNext = yearIdx < this.availableYears.length - 1;
                    
                    if (!d) {
                        return `
                            <div class="popup-title">${name}</div>
                            <div class="popup-year-nav">
                                <button class="popup-nav-btn" ${!hasPrev ? 'disabled' : ''} onclick="event.stopPropagation(); window.holzApp.prevYear(event)">‚óÄ</button>
                                <span>${this.selectedYear}</span>
                                <button class="popup-nav-btn" ${!hasNext ? 'disabled' : ''} onclick="event.stopPropagation(); window.holzApp.nextYear(event)">‚ñ∂</button>
                            </div>
                            <div style="padding: 1rem 0; color: #999; text-align: center;">Keine Daten f√ºr ${this.selectedYear}</div>
                        `;
                    }
                    
                    // d = [lp, la, h, v, co2, ets, ets_pc]
                    return `
                        <div class="popup-title">${name}</div>
                        <div class="popup-year-nav">
                            <button class="popup-nav-btn" ${!hasPrev ? 'disabled' : ''} onclick="event.stopPropagation(); window.holzApp.prevYear(event)">‚óÄ</button>
                            <span>${state} | ${this.selectedYear}</span>
                            <button class="popup-nav-btn" ${!hasNext ? 'disabled' : ''} onclick="event.stopPropagation(); window.holzApp.nextYear(event)">‚ñ∂</button>
                        </div>
                        <div class="popup-stat popup-highlight">
                            <span class="popup-stat-label">üõ∞Ô∏è Waldverlust</span>
                            <span class="popup-stat-value" style="color: #2e7d32;">${(d[1] || 0).toFixed(1)} ha</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">ü™µ Gesch. Einschlag</span>
                            <span class="popup-stat-value">${this.formatNumber(d[2])} Efm</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">üí∞ Holzwert</span>
                            <span class="popup-stat-value">‚Ç¨${this.formatNumber(d[3])}</span>
                        </div>
                        <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid #ddd;">
                        <div class="popup-stat" style="background: #ffebee; margin: 0 -0.5rem; padding: 0.25rem 0.5rem;">
                            <span class="popup-stat-label">üè≠ CO‚ÇÇ-Emissionen</span>
                            <span class="popup-stat-value" style="color: #c0392b;">${this.formatNumber(d[4])} t</span>
                        </div>
                        <div class="popup-stat" style="background: #fff3e0; margin: 0 -0.5rem; padding: 0.25rem 0.5rem;">
                            <span class="popup-stat-label">üí∏ ETS-Haftung</span>
                            <span class="popup-stat-value" style="color: #e65100;">‚Ç¨${this.formatNumber(d[5])}</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">üë• ETS pro Kopf</span>
                            <span class="popup-stat-value" style="font-weight: bold;">‚Ç¨${(d[6] || 0).toFixed(2)}</span>
                        </div>
                        <div style="font-size: 0.65rem; color: #999; margin-top: 0.5rem;">Bev√∂lkerung: ${this.formatNumber(pop)}</div>
                    `;
                },
                
                openPopupFor(iso, layer) {
                    const content = this.buildPopupContent(iso);
                    
                    if (layer) {
                        this.activePopup = layer.bindPopup(content, { maxWidth: 300, closeOnClick: false, autoClose: false }).openPopup().getPopup();
                    } else {
                        // Find layer by ISO
                        this.gemeindenLayer.eachLayer((l) => {
                            if (l.feature?.properties?.iso === iso) {
                                this.activePopup = l.bindPopup(content, { maxWidth: 300, closeOnClick: false, autoClose: false }).openPopup().getPopup();
                            }
                        });
                    }
                },
                
                selectMuni(iso) {
                    this.selectedMuni = iso;
                    this.openMuniModal(iso);
                    this.showShiftHintOnce();
                    
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.eachLayer((layer) => {
                            if (layer.feature?.properties?.iso === iso) {
                                const bounds = layer.getBounds();
                                this.map.flyToBounds(bounds, { 
                                    maxZoom: 11, 
                                    padding: [50, 50],
                                    duration: 1.0
                                });
                            }
                        });
                    }
                },
                
                highlightMuni(iso) {
                    this.highlightedMuni = iso;
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                },
                
                loadMore() {
                    this.displayCount = Math.min(this.displayCount + 20, this.sortedMunicipalities.length);
                },
                
                formatNumber(num) {
                    if (!num) return '0';
                    return new Intl.NumberFormat('de-AT').format(Math.round(num));
                },
                
                formatMillion(num) {
                    if (!num) return '0';
                    return (num / 1e6).toFixed(1);
                },
                
                formatThousand(num) {
                    if (!num) return '0';
                    if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
                    if (num >= 1e3) return (num / 1e3).toFixed(0) + 'k';
                    return Math.round(num).toString();
                },
                
                // Get loss area for a specific year for the modal municipality
                getYearLossArea(year) {
                    if (!this.modalMuniIso) return 0;
                    const d = this.yearData[year]?.[this.modalMuniIso];
                    return d ? (d[1] || 0) : 0; // d[1] is loss_area_ha
                },
                
                // Get bar height as percentage for chart
                getYearBarHeight(year) {
                    if (!this.modalMuniIso) return 5;
                    
                    // Find max loss area across all years for this municipality
                    let maxLoss = 0;
                    for (const y of this.availableYears) {
                        const d = this.yearData[y]?.[this.modalMuniIso];
                        if (d && d[1] > maxLoss) maxLoss = d[1];
                    }
                    
                    if (maxLoss === 0) return 5;
                    
                    const loss = this.getYearLossArea(year);
                    // Minimum height of 5%, scale the rest
                    return Math.max(5, (loss / maxLoss) * 100);
                },
                
                getModalChartBarClass(year) {
                    const classes = {};
                    
                    if (this.isRangeSelected) {
                        const start = Math.min(parseInt(this.rangeStartYear), parseInt(this.rangeEndYear));
                        const end = Math.max(parseInt(this.rangeStartYear), parseInt(this.rangeEndYear));
                        const yr = parseInt(year);
                        
                        if (yr === start) {
                            classes['range-start'] = true;
                        } else if (yr === end) {
                            classes['range-end'] = true;
                        } else if (yr > start && yr < end) {
                            classes['in-range'] = true;
                        }
                    } else {
                        if (year === this.selectedYear) {
                            classes.active = true;
                        }
                    }
                    
                    return classes;
                },
                
                async handleModalChartClick(event, year) {
                    if (event.shiftKey && (this.selectedYear || this.rangeStartYear)) {
                        // Shift+click: set/extend range
                        const baseYear = this.rangeStartYear || this.selectedYear;
                        this.rangeStartYear = baseYear;
                        this.rangeEndYear = year;
                        this.processingRange = true;
                        
                        await this.loadRangeYears();
                        
                        // Pre-compute aggregated data ONCE
                        this.cachedAggregatedData = this.computeAggregatedYearData();
                        
                        // Defer map update to let UI show loading state
                        await new Promise(r => requestAnimationFrame(r));
                        
                        this.displayCount = 20;
                        if (this.gemeindenLayer) {
                            this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                        }
                        this.processingRange = false;
                    } else {
                        // Normal click: single year, clear range
                        this.rangeStartYear = null;
                        this.rangeEndYear = null;
                        this.cachedAggregatedData = null;
                        await this.selectYear(year);
                    }
                }
            };
        }
    </script>
</body>
</html>