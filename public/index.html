<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holzeinschlag √ñsterreich - Gemeinden</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2d5a27;
            --primary-dark: #1e3d1a;
            --accent: #e67e22;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 400px;
            background: var(--card-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        .sidebar-header h1 { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.25rem; }
        .sidebar-header .subtitle { font-size: 0.85rem; opacity: 0.9; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 1rem; }
        
        /* Year selector */
        .year-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 8px;
        }
        .year-selector label { font-weight: 500; font-size: 0.9rem; }
        .year-selector select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        
        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 0.875rem;
        }
        .stat-card.full-width { grid-column: 1 / -1; }
        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .stat-value.small { font-size: 1.1rem; }
        .stat-unit { font-size: 0.75rem; color: var(--text-light); font-weight: 400; }
        
        /* Section headers */
        .section-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 1rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-header::after { content: ''; flex: 1; height: 1px; background: #e0e0e0; }
        
        /* Municipality list */
        .muni-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .muni-item {
            display: flex;
            align-items: center;
            padding: 0.625rem 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .muni-item:hover { background: #e8f5e9; transform: translateX(4px); }
        .muni-item.active { background: #c8e6c9; border-left: 3px solid var(--primary); }
        .muni-rank {
            width: 22px; height: 22px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            margin-right: 0.6rem;
            flex-shrink: 0;
        }
        .muni-info { flex: 1; min-width: 0; }
        .muni-name { font-weight: 500; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .muni-state { font-size: 0.7rem; color: var(--text-light); }
        .muni-stats { text-align: right; font-size: 0.8rem; }
        .muni-harvest { font-weight: 600; color: var(--primary); }
        .muni-value { font-size: 0.7rem; color: var(--text-light); }
        
        /* Load more button */
        .load-more {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background: transparent;
            color: var(--text-light);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .load-more:hover { border-color: var(--primary); color: var(--primary); background: #f0f7f0; }
        
        /* Legend */
        .legend {
            margin-top: 1rem;
            padding: 0.875rem;
            background: var(--bg);
            border-radius: 10px;
        }
        .legend-title { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        .legend-scale { display: flex; height: 10px; border-radius: 5px; overflow: hidden; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-light); margin-top: 0.25rem; }
        
        /* Footer */
        .sidebar-footer {
            padding: 0.875rem;
            border-top: 1px solid #e0e0e0;
            font-size: 0.7rem;
            color: var(--text-light);
        }
        .sidebar-footer a { color: var(--primary); text-decoration: none; }
        
        /* Map */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        
        /* Popup */
        .leaflet-popup-content-wrapper { border-radius: 10px; }
        .popup-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; color: var(--primary); }
        .popup-stat { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.85rem; }
        .popup-stat-label { color: var(--text-light); }
        .popup-stat-value { font-weight: 500; }
        .popup-highlight { background: #e8f5e9; margin: 0.25rem -0.5rem; padding: 0.25rem 0.5rem; }
        
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 45vh; }
            .map-container { min-height: 55vh; }
        }
    </style>
</head>
<body>
    <div class="app-container" x-data="holzeinschlagApp()">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üå≤ Holzeinschlag √ñsterreich</h1>
                <div class="subtitle">Timber Harvest by Municipality</div>
            </div>
            
            <div class="sidebar-content">
                <!-- Year selector -->
                <div class="year-selector">
                    <label>üìÖ Jahr:</label>
                    <select x-model="selectedYear" @change="updateYear()">
                        <template x-for="year in availableYears" :key="year">
                            <option :value="year" x-text="year"></option>
                        </template>
                    </select>
                </div>
                
                <!-- Austria totals -->
                <div class="stats-grid">
                    <div class="stat-card full-width">
                        <div class="stat-label">Gesamteinschlag √ñsterreich</div>
                        <div class="stat-value">
                            <span x-text="formatNumber(yearSummary?.total_harvest_efm)"></span>
                            <span class="stat-unit">Efm</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üí∞ Gesch√§tzter Wert</div>
                        <div class="stat-value small">
                            ‚Ç¨<span x-text="formatBillion(yearSummary?.total_value_eur)"></span>
                            <span class="stat-unit">Mrd.</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üìä Holzpreis</div>
                        <div class="stat-value small">
                            ‚Ç¨<span x-text="yearSummary?.price_eur_efm?.toFixed(2)"></span>
                            <span class="stat-unit">/Efm</span>
                        </div>
                    </div>
                    <div class="stat-card full-width">
                        <div class="stat-label">üõ∞Ô∏è Waldverlust (Hansen Satellitendaten)</div>
                        <div class="stat-value small">
                            <span x-text="formatNumber(yearSummary?.deforestation_ha)"></span>
                            <span class="stat-unit">ha</span>
                        </div>
                    </div>
                </div>
                
                <!-- Top municipalities -->
                <div class="section-header">üèÜ Top Gemeinden (nach Einschlag)</div>
                <div class="muni-list">
                    <template x-for="(muni, index) in displayedMunicipalities" :key="muni.iso">
                        <div class="muni-item"
                             :class="{ active: selectedMuni === muni.iso }"
                             @click="selectMuni(muni.iso)"
                             @mouseenter="highlightMuni(muni.iso)"
                             @mouseleave="highlightMuni(null)">
                            <div class="muni-rank" x-text="index + 1"></div>
                            <div class="muni-info">
                                <div class="muni-name" x-text="muni.name"></div>
                                <div class="muni-state" x-text="muni.state"></div>
                            </div>
                            <div class="muni-stats">
                                <div class="muni-harvest" x-text="formatNumber(muni.harvest) + ' Efm'"></div>
                                <div class="muni-value" x-text="'‚Ç¨' + formatThousand(muni.value)"></div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Load more -->
                <button class="load-more" 
                        x-show="displayCount < sortedMunicipalities.length"
                        @click="loadMore()">
                    Mehr laden (<span x-text="displayCount"></span> / <span x-text="sortedMunicipalities.length"></span> Gemeinden)
                </button>
                
                <!-- Legend -->
                <div class="legend">
                    <div class="legend-title">Einschlag pro Gemeinde (Efm)</div>
                    <div class="legend-scale" style="background: linear-gradient(90deg, #f5f5f5, #c8e6c9, #81c784, #4caf50, #388e3c, #1b5e20);"></div>
                    <div class="legend-labels">
                        <span>0</span>
                        <span>5k</span>
                        <span>25k</span>
                        <span>50k</span>
                        <span>100k+</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                Datenquellen: <a href="https://www.bmluk.gv.at" target="_blank">BML</a> Holzeinschlagsmeldung, 
                <a href="https://glad.umd.edu/" target="_blank">Hansen/GLAD</a> Satellite Data<br>
                Einheit: Efm = Erntefestmeter (m¬≥ Holz ohne Rinde)
            </div>
        </aside>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <script>
        function holzeinschlagApp() {
            return {
                yearlyData: null,
                gemeindenGeoJson: null,
                gemeindenLayer: null,
                map: null,
                selectedYear: null,
                selectedMuni: null,
                highlightedMuni: null,
                displayCount: 20,
                
                get availableYears() {
                    return this.yearlyData?.years_available || [];
                },
                
                get yearSummary() {
                    return this.yearlyData?.summary?.[this.selectedYear];
                },
                
                get currentYearData() {
                    return this.yearlyData?.gemeinden?.[this.selectedYear] || {};
                },
                
                get sortedMunicipalities() {
                    const data = this.currentYearData;
                    return Object.entries(data)
                        .map(([iso, d]) => ({
                            iso,
                            name: d.n,
                            state: d.s,
                            harvest: d.h,
                            value: d.v,
                            loss: d.l,
                            price: d.p
                        }))
                        .sort((a, b) => b.harvest - a.harvest);
                },
                
                get displayedMunicipalities() {
                    return this.sortedMunicipalities.slice(0, this.displayCount);
                },
                
                async init() {
                    // Load data
                    const [yearlyResp, geoResp] = await Promise.all([
                        fetch('/data/gemeinde_yearly.json'),
                        fetch('/data/austria_gemeinden.geojson')
                    ]);
                    
                    this.yearlyData = await yearlyResp.json();
                    this.gemeindenGeoJson = await geoResp.json();
                    
                    // Set default to latest year
                    if (this.availableYears.length > 0) {
                        this.selectedYear = this.availableYears[this.availableYears.length - 1];
                    }
                    
                    // Initialize map
                    this.initMap();
                },
                
                initMap() {
                    this.map = L.map('map', {
                        center: [47.5, 13.5],
                        zoom: 7,
                        zoomControl: false
                    });
                    
                    L.control.zoom({ position: 'bottomright' }).addTo(this.map);
                    
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© OSM ¬© CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(this.map);
                    
                    this.createGemeindenLayer();
                },
                
                createGemeindenLayer() {
                    if (this.gemeindenLayer) {
                        this.map.removeLayer(this.gemeindenLayer);
                    }
                    
                    this.gemeindenLayer = L.geoJSON(this.gemeindenGeoJson, {
                        style: (feature) => this.getStyle(feature),
                        onEachFeature: (feature, layer) => {
                            layer.on({
                                click: (e) => this.onMuniClick(feature, layer),
                                mouseover: (e) => {
                                    layer.setStyle({ weight: 2, color: '#1e3d1a' });
                                    layer.bringToFront();
                                },
                                mouseout: (e) => {
                                    this.gemeindenLayer.resetStyle(layer);
                                }
                            });
                        }
                    }).addTo(this.map);
                },
                
                getStyle(feature) {
                    const iso = feature.properties.iso;
                    const data = this.currentYearData[iso];
                    const harvest = data?.h || 0;
                    
                    const isHighlighted = this.highlightedMuni === iso || this.selectedMuni === iso;
                    
                    return {
                        fillColor: this.getColor(harvest),
                        weight: isHighlighted ? 2 : 0.5,
                        opacity: 1,
                        color: isHighlighted ? '#1e3d1a' : '#ffffff',
                        fillOpacity: 0.75
                    };
                },
                
                getColor(harvest) {
                    if (harvest === 0) return '#f5f5f5';
                    if (harvest < 1000) return '#e8f5e9';
                    if (harvest < 5000) return '#c8e6c9';
                    if (harvest < 10000) return '#a5d6a7';
                    if (harvest < 25000) return '#81c784';
                    if (harvest < 50000) return '#66bb6a';
                    if (harvest < 75000) return '#4caf50';
                    if (harvest < 100000) return '#43a047';
                    if (harvest < 150000) return '#388e3c';
                    return '#1b5e20';
                },
                
                onMuniClick(feature, layer) {
                    const iso = feature.properties.iso;
                    const data = this.currentYearData[iso];
                    
                    if (!data) {
                        layer.bindPopup(`<b>${feature.properties.name}</b><br>Keine Daten verf√ºgbar`).openPopup();
                        return;
                    }
                    
                    this.selectedMuni = iso;
                    
                    const content = `
                        <div class="popup-title">${data.n}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.5rem;">${data.s} | ${this.selectedYear}</div>
                        <div class="popup-stat popup-highlight">
                            <span class="popup-stat-label">ü™µ Einschlag</span>
                            <span class="popup-stat-value" style="color: #2e7d32;">${this.formatNumber(data.h)} Efm</span>
                        </div>
                        <div class="popup-stat popup-highlight">
                            <span class="popup-stat-label">üí∞ Gesch√§tzter Wert</span>
                            <span class="popup-stat-value" style="color: #2e7d32;">‚Ç¨${this.formatNumber(data.v)}</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">üõ∞Ô∏è Waldverlust (kumulativ)</span>
                            <span class="popup-stat-value">${data.l.toFixed(1)} ha</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">üìä Holzpreis</span>
                            <span class="popup-stat-value">‚Ç¨${data.p.toFixed(2)}/Efm</span>
                        </div>
                    `;
                    layer.bindPopup(content, { maxWidth: 300 }).openPopup();
                },
                
                updateYear() {
                    this.displayCount = 20;
                    this.selectedMuni = null;
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                },
                
                selectMuni(iso) {
                    this.selectedMuni = iso;
                    
                    // Find the layer and open popup
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.eachLayer((layer) => {
                            if (layer.feature?.properties?.iso === iso) {
                                const bounds = layer.getBounds();
                                this.map.fitBounds(bounds, { maxZoom: 11, padding: [50, 50] });
                                this.onMuniClick(layer.feature, layer);
                            }
                        });
                    }
                },
                
                highlightMuni(iso) {
                    this.highlightedMuni = iso;
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                },
                
                loadMore() {
                    this.displayCount = Math.min(this.displayCount + 20, this.sortedMunicipalities.length);
                },
                
                formatNumber(num) {
                    if (!num) return '0';
                    return new Intl.NumberFormat('de-AT').format(Math.round(num));
                },
                
                formatBillion(num) {
                    if (!num) return '0';
                    return (num / 1e9).toFixed(2);
                },
                
                formatThousand(num) {
                    if (!num) return '0';
                    if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
                    if (num >= 1e3) return (num / 1e3).toFixed(0) + 'k';
                    return num.toString();
                }
            };
        }
    </script>
</body>
</html>