<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holzeinschlag √ñsterreich - Gemeinden</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2d5a27;
            --primary-dark: #1e3d1a;
            --accent: #e67e22;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 400px;
            background: var(--card-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        .sidebar-header h1 { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.25rem; }
        .sidebar-header .subtitle { font-size: 0.85rem; opacity: 0.9; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 1rem; }
        
        /* Year toggle buttons */
        .year-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg);
            border-radius: 8px;
        }
        .year-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
            background: white;
            color: var(--text);
        }
        .year-btn:hover { background: #e8f5e9; }
        .year-btn.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        .year-btn.loading {
            opacity: 0.5;
            cursor: wait;
        }
        
        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 0.875rem;
        }
        .stat-card.full-width { grid-column: 1 / -1; }
        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .stat-value.small { font-size: 1.1rem; }
        .stat-unit { font-size: 0.75rem; color: var(--text-light); font-weight: 400; }
        
        /* Section headers */
        .section-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 1rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-header::after { content: ''; flex: 1; height: 1px; background: #e0e0e0; }
        
        /* Municipality list */
        .muni-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .muni-item {
            display: flex;
            align-items: center;
            padding: 0.625rem 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .muni-item:hover { background: #e8f5e9; transform: translateX(4px); }
        .muni-item.active { background: #c8e6c9; border-left: 3px solid var(--primary); }
        .muni-rank {
            width: 22px; height: 22px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            margin-right: 0.6rem;
            flex-shrink: 0;
        }
        .muni-info { flex: 1; min-width: 0; }
        .muni-name { font-weight: 500; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .muni-state { font-size: 0.7rem; color: var(--text-light); }
        .muni-stats { text-align: right; font-size: 0.8rem; }
        .muni-harvest { font-weight: 600; color: var(--primary); }
        .muni-value { font-size: 0.7rem; color: var(--text-light); }
        
        /* Load more button */
        .load-more {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background: transparent;
            color: var(--text-light);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .load-more:hover { border-color: var(--primary); color: var(--primary); background: #f0f7f0; }
        
        /* Legend */
        .legend {
            margin-top: 1rem;
            padding: 0.875rem;
            background: var(--bg);
            border-radius: 10px;
        }
        .legend-title { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        .legend-scale { display: flex; height: 10px; border-radius: 5px; overflow: hidden; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-light); margin-top: 0.25rem; }
        
        /* Footer */
        .sidebar-footer {
            padding: 0.875rem;
            border-top: 1px solid #e0e0e0;
            font-size: 0.7rem;
            color: var(--text-light);
        }
        .sidebar-footer a { color: var(--primary); text-decoration: none; }
        
        /* Map */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        
        /* Popup */
        .leaflet-popup-content-wrapper { border-radius: 10px; }
        .popup-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; color: var(--primary); }
        .popup-stat { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.85rem; }
        .popup-stat-label { color: var(--text-light); }
        .popup-stat-value { font-weight: 500; }
        .popup-highlight { background: #e8f5e9; margin: 0.25rem -0.5rem; padding: 0.25rem 0.5rem; }
        
        /* Loading spinner */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid var(--bg);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal h2 { color: var(--primary); margin-bottom: 1rem; font-size: 1.2rem; }
        .modal h3 { color: var(--text); margin: 1rem 0 0.5rem; font-size: 0.95rem; }
        .modal p, .modal li { font-size: 0.85rem; line-height: 1.5; color: var(--text); margin-bottom: 0.5rem; }
        .modal ul { padding-left: 1.2rem; }
        .modal a { color: var(--primary); }
        .modal-close {
            float: right;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }
        .modal-close:hover { color: var(--text); }
        
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 45vh; }
            .map-container { min-height: 55vh; }
        }
    </style>
</head>
<body>
    <div class="app-container" x-data="holzeinschlagApp()">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üå≤ Holzeinschlag √ñsterreich</h1>
                <div class="subtitle">Forest Loss & Carbon Emissions by Municipality</div>
            </div>
            
            <div class="sidebar-content">
                <!-- Year toggle buttons -->
                <div class="year-toggles">
                    <template x-for="year in availableYears" :key="year">
                        <button class="year-btn"
                                :class="{ active: selectedYear === year, loading: loadingYear === year }"
                                @click="selectYear(year)"
                                x-text="year"></button>
                    </template>
                </div>
                
                <!-- Austria totals -->
                <div class="stats-grid">
                    <div class="stat-card full-width">
                        <div class="stat-label">üõ∞Ô∏è Waldverlust (Hansen Satellitendaten)</div>
                        <div class="stat-value">
                            <span x-text="formatNumber(yearSummary?.total_loss_area_ha)"></span>
                            <span class="stat-unit">ha</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üå≤ Gesch. Einschlag</div>
                        <div class="stat-value small">
                            <span x-text="formatNumber(yearSummary?.total_harvest_efm)"></span>
                            <span class="stat-unit">Efm</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üí∞ Holzwert</div>
                        <div class="stat-value small">
                            ‚Ç¨<span x-text="formatMillion(yearSummary?.total_value_eur)"></span>
                            <span class="stat-unit">Mio.</span>
                        </div>
                    </div>
                    <div class="stat-card" style="background: #ffebee;">
                        <div class="stat-label">üè≠ CO‚ÇÇ-Emissionen</div>
                        <div class="stat-value small" style="color: #c0392b;">
                            <span x-text="formatNumber(yearSummary?.total_co2_tonnes)"></span>
                            <span class="stat-unit">t</span>
                        </div>
                    </div>
                    <div class="stat-card" style="background: #fff3e0;">
                        <div class="stat-label">üí∏ ETS-Haftung</div>
                        <div class="stat-value small" style="color: #e65100;">
                            ‚Ç¨<span x-text="formatMillion(yearSummary?.total_ets_liability_eur)"></span>
                            <span class="stat-unit">Mio.</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üìä ETS-Preis</div>
                        <div class="stat-value small">
                            ‚Ç¨<span x-text="yearSummary?.ets_price_eur_tco2"></span>
                            <span class="stat-unit">/tCO‚ÇÇ</span>
                        </div>
                    </div>
                </div>
                
                <!-- Top municipalities -->
                <div class="section-header">üèÜ Top Gemeinden (nach Efm)</div>
                <div class="muni-list">
                    <template x-for="(muni, index) in displayedMunicipalities" :key="muni.iso">
                        <div class="muni-item"
                             :class="{ active: selectedMuni === muni.iso }"
                             @click="selectMuni(muni.iso)"
                             @mouseenter="highlightMuni(muni.iso)"
                             @mouseleave="highlightMuni(null)">
                            <div class="muni-rank" x-text="index + 1"></div>
                            <div class="muni-info">
                                <div class="muni-name" x-text="muni.name"></div>
                                <div class="muni-state" x-text="muni.state"></div>
                            </div>
                            <div class="muni-stats">
                                <div class="muni-harvest" x-text="formatNumber(muni.harvest) + ' Efm'"></div>
                                <div class="muni-value" x-text="'‚Ç¨' + formatThousand(muni.value)"></div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Load more -->
                <button class="load-more" 
                        x-show="displayCount < sortedMunicipalities.length"
                        @click="loadMore()">
                    Mehr laden (<span x-text="displayCount"></span> / <span x-text="sortedMunicipalities.length"></span>)
                </button>
                
                <!-- Legend -->
                <div class="legend">
                    <div class="legend-title">Waldverlust pro Gemeinde</div>
                    <div class="legend-scale" style="background: linear-gradient(90deg, #f5f5f5, #c8e6c9, #81c784, #4caf50, #388e3c, #1b5e20);"></div>
                    <div class="legend-labels">
                        <span>0</span>
                        <span>100</span>
                        <span>500</span>
                        <span>1000+ ha</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <a href="#" @click.prevent="showMethodsModal = true" style="margin-right: 1rem;">Methoden & Quellen</a>
                <a href="/holzeinschlag_austria.gpkg" download>üì• GeoPackage</a>
            </div>
        </aside>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <div class="loading-overlay" x-show="loading" x-cloak>
                <div class="spinner"></div>
            </div>
        </div>
        
        <!-- Methods Modal -->
        <div class="modal-overlay" x-show="showMethodsModal" x-cloak @click.self="showMethodsModal = false">
            <div class="modal">
                <button class="modal-close" @click="showMethodsModal = false">&times;</button>
                <h2>üìä Methoden & Datenquellen</h2>
                
                <h3>üõ∞Ô∏è Waldverlust (Forest Loss)</h3>
                <p>Satellitendaten aus dem <a href="https://glad.umd.edu/dataset/gfc-2023-v1.11" target="_blank">Hansen Global Forest Change</a> Datensatz (v1.11, 2023). 30m Aufl√∂sung, Wert 1-23 entspricht Verlustjahr 2001-2023.</p>
                
                <h3>üå≤ Gesch√§tzter Einschlag</h3>
                <p>Berechnet aus Waldverlustfl√§che √ó bundeslandspezifischem Efm/ha-Faktor. Der Faktor basiert auf dem Verh√§ltnis von offiziellen Einschlagszahlen (<a href="https://www.bmluk.gv.at" target="_blank">BML</a>) zur Hansen-Verlustfl√§che pro Bundesland.</p>
                
                <h3>üí∞ Holzwert</h3>
                <p>Gesch√§tzter Einschlag √ó historischer Holzpreis (gewichteter Durchschnitt aus S√§gerundholz und Industrieholz).</p>
                
                <h3>üè≠ CO‚ÇÇ-Emissionen</h3>
                <p>Berechnung basiert auf Schadholzanteil:</p>
                <ul>
                    <li>Schadholzfraktion: 40-55% je Bundesland</li>
                    <li>Emissionsfaktor: 0.9 tCO‚ÇÇ/m¬≥ f√ºr Holz, das verbrannt oder zu Zellstoff verarbeitet wird</li>
                    <li>Nachhaltig bewirtschaftetes S√§geholz wird nicht eingerechnet (Kohlenstoffbindung in Produkten)</li>
                </ul>
                
                <h3>üí∏ ETS-Haftung</h3>
                <p>CO‚ÇÇ-Emissionen √ó historischer EU-ETS-Preis. Preise von 2005-2023 basieren auf realen Marktdaten. <em>Hinweis: Forstwirtschaft ist derzeit nicht im EU-ETS enthalten - dies ist eine hypothetische Berechnung.</em></p>
                
                <h3>üì• Datendownload</h3>
                <p>GeoPackage enth√§lt alle 2.118 Gemeinden mit Daten f√ºr 2001-2023. Felder pro Jahr:</p>
                <ul>
                    <li><code>loss_pixels_YYYY</code> - Anzahl 30m-Pixel</li>
                    <li><code>loss_area_ha_YYYY</code> - Verlustfl√§che in Hektar</li>
                    <li><code>harvest_efm_YYYY</code> - Gesch√§tzter Einschlag</li>
                    <li><code>value_eur_YYYY</code> - Holzwert in EUR</li>
                    <li><code>co2_tonnes_YYYY</code> - CO‚ÇÇ-Emissionen</li>
                    <li><code>ets_eur_YYYY</code> - ETS-Haftung</li>
                    <li><code>ets_per_capita_YYYY</code> - ETS pro Einwohner</li>
                </ul>
                
                <h3>‚ö†Ô∏è Einschr√§nkungen</h3>
                <ul>
                    <li>Hansen-Daten erfassen Kronenverlust, nicht nur Holzeinschlag</li>
                    <li>Einschlagsch√§tzung ist ein Proxy, keine direkte Messung</li>
                    <li>Bev√∂lkerungsdaten nur f√ºr aktuelle Jahre verf√ºgbar</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        function holzeinschlagApp() {
            return {
                // Data stores
                meta: null,
                lookup: null,
                yearData: {},      // Cache: { year: data }
                gemeindenGeoJson: null,
                
                // UI state
                selectedYear: '2023',
                selectedMuni: null,
                highlightedMuni: null,
                displayCount: 20,
                loading: true,
                loadingYear: null,
                showMethodsModal: false,
                
                // Map
                map: null,
                gemeindenLayer: null,
                activePopup: null,
                
                get availableYears() {
                    return this.meta?.years || [];
                },
                
                get yearSummary() {
                    return this.meta?.summary?.[this.selectedYear];
                },
                
                get currentYearData() {
                    return this.yearData[this.selectedYear] || {};
                },
                
                get sortedMunicipalities() {
                    const data = this.currentYearData;
                    const lookup = this.lookup || {};
                    
                    return Object.entries(data)
                        .map(([iso, d]) => ({
                            iso,
                            name: lookup.names?.[iso] || iso,
                            state: lookup.states?.[iso] || '',
                            lossPixels: d[0] || 0,
                            lossArea: d[1] || 0,
                            harvest: d[2] || 0,
                            value: d[3] || 0,
                            co2: d[4] || 0,
                            ets: d[5] || 0,
                            etsPc: d[6] || 0,
                            population: lookup.population?.[iso] || 0
                        }))
                        .sort((a, b) => b.harvest - a.harvest);
                },
                
                get displayedMunicipalities() {
                    return this.sortedMunicipalities.slice(0, this.displayCount);
                },
                
                async init() {
                    this.loading = true;
                    
                    // Load metadata and lookup (small files, load first)
                    const [metaResp, lookupResp, geoResp] = await Promise.all([
                        fetch('/data/emissions_meta.json'),
                        fetch('/data/gemeinde_lookup.json'),
                        fetch('/data/austria_gemeinden.geojson')
                    ]);
                    
                    this.meta = await metaResp.json();
                    this.lookup = await lookupResp.json();
                    this.gemeindenGeoJson = await geoResp.json();
                    
                    // Load default year data
                    await this.loadYearData(this.selectedYear);
                    
                    // Initialize map
                    this.initMap();
                    this.loading = false;
                },
                
                async loadYearData(year) {
                    if (this.yearData[year]) return; // Already cached
                    
                    this.loadingYear = year;
                    const resp = await fetch(`/data/year_${year}.json`);
                    this.yearData[year] = await resp.json();
                    this.loadingYear = null;
                },
                
                async selectYear(year) {
                    if (year === this.selectedYear) return;
                    
                    // Close any open popup
                    if (this.activePopup) {
                        this.map.closePopup(this.activePopup);
                        this.activePopup = null;
                    }
                    
                    await this.loadYearData(year);
                    this.selectedYear = year;
                    this.displayCount = 20;
                    this.selectedMuni = null;
                    
                    // Update map colors
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                    
                    // Reopen popup for selected municipality if any
                    if (this.selectedMuni) {
                        this.openPopupFor(this.selectedMuni);
                    }
                },
                
                initMap() {
                    this.map = L.map('map', {
                        center: [47.5, 13.5],
                        zoom: 7,
                        zoomControl: false
                    });
                    
                    L.control.zoom({ position: 'bottomright' }).addTo(this.map);
                    
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© OSM ¬© CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(this.map);
                    
                    this.createGemeindenLayer();
                },
                
                createGemeindenLayer() {
                    this.gemeindenLayer = L.geoJSON(this.gemeindenGeoJson, {
                        style: (feature) => this.getStyle(feature),
                        onEachFeature: (feature, layer) => {
                            layer.on({
                                click: (e) => this.onMuniClick(feature, layer),
                                mouseover: (e) => {
                                    layer.setStyle({ weight: 2, color: '#1e3d1a' });
                                    layer.bringToFront();
                                },
                                mouseout: (e) => {
                                    this.gemeindenLayer.resetStyle(layer);
                                }
                            });
                        }
                    }).addTo(this.map);
                },
                
                getStyle(feature) {
                    const iso = feature.properties.iso;
                    const d = this.currentYearData[iso];
                    const lossArea = d ? d[1] : 0;  // d[1] = loss area
                    
                    const isHighlighted = this.highlightedMuni === iso || this.selectedMuni === iso;
                    
                    return {
                        fillColor: this.getColor(lossArea),
                        weight: isHighlighted ? 2 : 0.5,
                        opacity: 1,
                        color: isHighlighted ? '#1e3d1a' : '#ffffff',
                        fillOpacity: 0.75
                    };
                },
                
                getColor(lossArea) {
                    if (!lossArea || lossArea === 0) return '#f5f5f5';
                    if (lossArea < 10) return '#e8f5e9';
                    if (lossArea < 50) return '#c8e6c9';
                    if (lossArea < 100) return '#a5d6a7';
                    if (lossArea < 200) return '#81c784';
                    if (lossArea < 500) return '#66bb6a';
                    if (lossArea < 750) return '#4caf50';
                    if (lossArea < 1000) return '#43a047';
                    if (lossArea < 1500) return '#388e3c';
                    return '#1b5e20';
                },
                
                onMuniClick(feature, layer) {
                    const iso = feature.properties.iso;
                    this.selectedMuni = iso;
                    this.openPopupFor(iso, layer);
                },
                
                openPopupFor(iso, layer) {
                    const d = this.currentYearData[iso];
                    const name = this.lookup?.names?.[iso] || iso;
                    const state = this.lookup?.states?.[iso] || '';
                    const pop = this.lookup?.population?.[iso] || 0;
                    
                    if (!d) {
                        const content = `<b>${name}</b><br>Keine Daten f√ºr ${this.selectedYear}`;
                        if (layer) layer.bindPopup(content).openPopup();
                        return;
                    }
                    
                    // d = [lp, la, h, v, co2, ets, ets_pc]
                    const content = `
                        <div class="popup-title">${name}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.5rem;">${state} | ${this.selectedYear}</div>
                        <div class="popup-stat popup-highlight">
                            <span class="popup-stat-label">üõ∞Ô∏è Waldverlust</span>
                            <span class="popup-stat-value" style="color: #2e7d32;">${(d[1] || 0).toFixed(1)} ha</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">ü™µ Gesch. Einschlag</span>
                            <span class="popup-stat-value">${this.formatNumber(d[2])} Efm</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">üí∞ Holzwert</span>
                            <span class="popup-stat-value">‚Ç¨${this.formatNumber(d[3])}</span>
                        </div>
                        <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid #ddd;">
                        <div class="popup-stat" style="background: #ffebee; margin: 0 -0.5rem; padding: 0.25rem 0.5rem;">
                            <span class="popup-stat-label">üè≠ CO‚ÇÇ-Emissionen</span>
                            <span class="popup-stat-value" style="color: #c0392b;">${this.formatNumber(d[4])} t</span>
                        </div>
                        <div class="popup-stat" style="background: #fff3e0; margin: 0 -0.5rem; padding: 0.25rem 0.5rem;">
                            <span class="popup-stat-label">üí∏ ETS-Haftung</span>
                            <span class="popup-stat-value" style="color: #e65100;">‚Ç¨${this.formatNumber(d[5])}</span>
                        </div>
                        <div class="popup-stat">
                            <span class="popup-stat-label">üë• ETS pro Kopf</span>
                            <span class="popup-stat-value" style="font-weight: bold;">‚Ç¨${(d[6] || 0).toFixed(2)}</span>
                        </div>
                        <div style="font-size: 0.65rem; color: #999; margin-top: 0.5rem;">Bev√∂lkerung: ${this.formatNumber(pop)}</div>
                    `;
                    
                    if (layer) {
                        this.activePopup = layer.bindPopup(content, { maxWidth: 300 }).openPopup().getPopup();
                    } else {
                        // Find layer by ISO
                        this.gemeindenLayer.eachLayer((l) => {
                            if (l.feature?.properties?.iso === iso) {
                                this.activePopup = l.bindPopup(content, { maxWidth: 300 }).openPopup().getPopup();
                            }
                        });
                    }
                },
                
                selectMuni(iso) {
                    this.selectedMuni = iso;
                    
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.eachLayer((layer) => {
                            if (layer.feature?.properties?.iso === iso) {
                                const bounds = layer.getBounds();
                                this.map.fitBounds(bounds, { maxZoom: 11, padding: [50, 50] });
                                this.openPopupFor(iso, layer);
                            }
                        });
                    }
                },
                
                highlightMuni(iso) {
                    this.highlightedMuni = iso;
                    if (this.gemeindenLayer) {
                        this.gemeindenLayer.setStyle((f) => this.getStyle(f));
                    }
                },
                
                loadMore() {
                    this.displayCount = Math.min(this.displayCount + 20, this.sortedMunicipalities.length);
                },
                
                formatNumber(num) {
                    if (!num) return '0';
                    return new Intl.NumberFormat('de-AT').format(Math.round(num));
                },
                
                formatMillion(num) {
                    if (!num) return '0';
                    return (num / 1e6).toFixed(1);
                },
                
                formatThousand(num) {
                    if (!num) return '0';
                    if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
                    if (num >= 1e3) return (num / 1e3).toFixed(0) + 'k';
                    return Math.round(num).toString();
                }
            };
        }
    </script>
</body>
</html>